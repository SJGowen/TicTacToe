@page "/"
@page "/tictactoe"
@using global::TicTacToe.Code

@inject GameState GameState

<PageTitle>TicTacToe</PageTitle>

<div class="container-fluid px-3">
    <h4>Select Player Types</h4>
    <form>
        <div class="mb-3 row">
            <label for="playerX" class="col-auto col-form-label">Player X</label>
            <div class="col">
                <select id="playerX" class="form-select" @bind="playerXType" disabled="@GameState.GameStarted">
                    <option value="Human">Human</option>
                    <option value="Computer">Computer</option>
                </select>
            </div>
        </div>
        <div class="mb-3 row">
            <label for="playerO" class="col-auto col-form-label mb-0">Player O</label>
            <div class="col">
                <select id="playerO" class="form-select" @bind="playerOType" disabled="@GameState.GameStarted">
                    <option value="Human">Human</option>
                    <option value="Computer">Computer</option>
                </select>
            </div>
        </div>
    </form>
</div>

<div class="info-bar" aria-label="Select Player Types">
    @if (GameState.GameStarted && !GameState.Board.GameComplete)
    {
        <h2 class="info">@GameState.Board.CurrentStyle's Turn!</h2>
    }
    else if (GameState.GameStarted || !string.IsNullOrEmpty(GameState.GameCompleteMessage))
    {
        <h2 class="info">@GameState.GameCompleteMessage</h2>
    }
    else if (!GameState.GameStarted)
    {
        <h2 class="info">@GameState.SelectPlayers</h2>
    }
</div>

<div class="d-flex align-items-center mt-3 gap-2">
    <button type="button" class="btn btn-primary" @onclick="ToggleGame">
        @GameState.ButtonText
    </button>
</div>

<div class="board-wrapper" style="position: relative;">
    <div class="tictactoe-board @(GameState.GameStarted ? "" : "disabled")">
        @for (int row = 0; row < Constants.BoardSize; row++)
        {
            <div class="tictactoe-column">
                @for (int col = 0; col < Constants.BoardSize; col++)
                {
                    int savedRow = row;
                    int savedCol = col;
                    <div class="tictactoe-gamepiece" @onclick="@(() => OnGamePieceClicked(savedRow, savedCol))">
                        @if (GameState.Board.Board[row, col].Style != Code.PieceStyle.Blank)
                        {
                            <span class="tictactoe-@GameState.Board.Board[row,col].Style.ToString().ToLower() @(GameState.Board.IsGamePieceAWinningPiece(row, col) ? "flashing" : "")">
                                @GameState.Board.Board[row, col].Style
                            </span>
                        }
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private Code.PlayerType playerXType = Code.PlayerType.Human;
    private Code.PlayerType playerOType = Code.PlayerType.Human;
    private CancellationTokenSource? cancellationTokenSource;

    public TicTacToe()
    {
        // Empty constructor required for WebAssembly
    }

    private async Task ToggleGame()
    {
        if (GameState.GameStarted)
        {
            await StopGame();
        }
        else
        {
            await StartGame();
        }
    }

    private async Task StartGame()
    {
        GameState.ResetGame(playerXType, playerOType);
        GameState.GameStarted = true;
        cancellationTokenSource = new CancellationTokenSource();

        try
        {
            while (!GameState.Board.GameComplete && !cancellationTokenSource.Token.IsCancellationRequested)
            {
                await GameState.Board.MakeComputerMoveIfNeededAsync();
                StateHasChanged();
                await Task.Delay(400, cancellationTokenSource.Token);
            }

            if (!cancellationTokenSource.Token.IsCancellationRequested)
            {
                GameState.UpdateGameCompleteMessage();
                GameState.GameStarted = false;
                StateHasChanged();
            }
        }
        catch (TaskCanceledException)
        {
            // Handle task cancellation if needed
        }
    }

    private Task StopGame()
    {
        cancellationTokenSource?.Cancel();
        GameState.ResetGame(playerXType, playerOType);
        return Task.CompletedTask;
    }

    private async Task OnGamePieceClicked(int row, int col)
    {
        if (GameState.GameStarted && !GameState.Board.GameComplete)
        {
            await GameState.Board.PieceClicked(new Position(row, col));
            StateHasChanged();
        }
    }
}
